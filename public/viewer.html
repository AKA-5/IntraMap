<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Interactive indoor floor plan navigation">
    <title>Floor Plan Viewer - IntraMap</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/viewer.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3B82F6">
    <script>
        window.INTRAMAP_API_URL = 'https://intramap-api.kaleempk555.workers.dev';
    </script>
</head>

<body>
    <div class="viewer-container">
        <!-- Header -->
        <div class="viewer-header">
            <!-- Back Button - Absolute Positioned -->
            <a href="index.html" class="back-btn" title="Back to Home">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
                Home
            </a>

            <!-- Version Indicator (Temporary for Debugging) -->
            <div
                style="position: absolute; top: 5px; right: 5px; font-size: 10px; color: #888; background: #eee; padding: 2px 5px; border-radius: 4px; pointer-events: none; z-index: 2000;">
                v5.0 COMPLETE
            </div>

            <!-- Building Name - Top Center -->
            <div class="building-title-main">
                <h1 id="buildingName">Loading...</h1>
            </div>

            <!-- Controls Row -->
            <div class="header-controls">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="search" id="searchInput" placeholder="Search places, tags..." autocomplete="off">
                    <div id="searchResults" class="search-results"></div>
                </div>

                <div class="floor-info">
                    <label>Floor:</label>
                    <select id="floorSelector" class="floor-selector">
                        <!-- Options populated dynamically -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="viewer-canvas-container">
            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="loading-overlay">
                <div class="spinner"></div>
                <h2>Loading floor plan...</h2>
                <p style="color: #666; margin-top: 10px; font-size: 14px;">Preparing interactive map...</p>
            </div>
            
            <!-- Welcome Instructions (shown on first visit) -->
            <div id="welcomeOverlay" class="welcome-overlay" style="display: none;">
                <div class="welcome-content">
                    <h2>Welcome to IntraMap! üó∫Ô∏è</h2>
                    <div class="welcome-instructions">
                        <div class="instruction-item">
                            <span class="instruction-icon">üîç</span>
                            <p><strong>Search:</strong> Use the search bar to find any location</p>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-icon">üìç</span>
                            <p><strong>Navigate:</strong> Click "You Are Here" to mark your location</p>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-icon">üè¢</span>
                            <p><strong>Explore:</strong> Switch floors using the dropdown menu</p>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-icon">üëÜ</span>
                            <p><strong>Details:</strong> Tap any location to see more information</p>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="dismissWelcome()" style="margin-top: 20px; width: 100%;">
                        Got it, let's explore!
                    </button>
                </div>
            </div>

            <!-- Keyboard Help Overlay -->
            <div id="keyboardHelpOverlay" class="welcome-overlay" style="display: none;">
                <div class="welcome-content">
                    <h2>Keyboard Shortcuts ‚å®Ô∏è</h2>
                    <div class="welcome-instructions">
                        <div class="instruction-item">
                            <span class="instruction-icon">‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÖÔ∏è‚û°Ô∏è</span>
                            <p><strong>Arrow Keys:</strong> Pan the map in any direction</p>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-icon">+/‚àí</span>
                            <p><strong>+ / - Keys:</strong> Zoom in or out</p>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-icon">0</span>
                            <p><strong>0 Key:</strong> Reset view to default zoom and position</p>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-icon">M</span>
                            <p><strong>M Key:</strong> Toggle "You Are Here" marker mode</p>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-icon">C</span>
                            <p><strong>C Key:</strong> Clear the "You Are Here" marker</p>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-icon">Esc</span>
                            <p><strong>Esc Key:</strong> Close popups and exit marker mode</p>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-icon">Space</span>
                            <p><strong>Space Key:</strong> Toggle welcome overlay</p>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="dismissKeyboardHelp()" style="margin-top: 20px; width: 100%;">
                        Close
                    </button>
                </div>
            </div>

            <!-- Canvas Wrapper -->
            <div class="viewer-canvas-wrapper">
                <canvas id="viewerCanvas"></canvas>
            </div>

            <!-- Controls -->
            <div class="viewer-controls">
                <div class="control-group">
                    <button class="btn btn-secondary btn-icon" onclick="zoomIn()" title="Zoom In (or press +)">üîç+</button>
                    <button class="btn btn-secondary btn-icon" onclick="zoomOut()" title="Zoom Out (or press -)">üîç-</button>
                    <button class="btn btn-secondary btn-icon" onclick="resetView()" title="Reset View (or press 0)">‚ü≤</button>
                    <button class="btn btn-secondary btn-icon" onclick="showKeyboardHelp()" title="Keyboard Shortcuts">‚å®Ô∏è</button>
                </div>
                <button id="youAreHereBtn" class="you-are-here-btn" onclick="toggleYouAreHere()">
                    üìç You Are Here
                </button>
                <button id="clearMarkerBtn" class="clear-marker-btn" onclick="clearMarker()" style="display: none;">
                    ‚úñÔ∏è Clear Marker
                </button>
            </div>

            <!-- Object Info Popup -->
            <div id="objectPopup" class="object-popup">
                <div class="popup-header">
                    <div class="popup-title">
                        <h3 id="popupName">Place Name</h3>
                        <span id="popupFloor" class="badge badge-primary">Ground Floor</span>
                    </div>
                    <button class="popup-close" onclick="closePopup()">√ó</button>
                </div>
                <div id="popupTags" class="popup-tags"></div>
                <div class="popup-actions">
                    <button class="btn btn-primary" onclick="getDirections()">
                        üìç Get Directions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="lib/fabric.min.js"></script>
    <script src="js/icons.js"></script>
    <script src="js/api.js"></script>
    <script src="js/viewer.js"></script>
</body>

</html>