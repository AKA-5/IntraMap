<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="description" content="Interactive indoor floor plan navigation">
    <link rel="icon" type="image/x-icon" href="icons/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="icons/logo.svg">
    <link rel="apple-touch-icon" href="icons/logo.svg">
    <title>Floor Plan Viewer - IntraMap</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/viewer.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3B82F6">
    <script>
        window.INTRAMAP_API_URL = 'https://intramap-api.kaleempk555.workers.dev';
    </script>
</head>

<body>
    <div class="viewer-container">
        <!-- Header -->
        <div class="viewer-header">
            <!-- Back Button - Absolute Positioned -->
            <a href="index.html" class="back-btn" title="Back to Home">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                <span>Home</span>
            </a>

            <!-- Version Indicator (Temporary for Debugging) -->
            <div class="version-indicator"
                style="position: absolute; top: 5px; right: 5px; font-size: 10px; color: #888; background: #eee; padding: 2px 5px; border-radius: 4px; pointer-events: none; z-index: 2000;">
                v5.0 COMPLETE
            </div>

            <!-- Search Bar - Top Right -->
            <div class="header-search">
                <div class="search-bar">
                    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="search" id="searchInput" placeholder="Search places, tags..." autocomplete="off">
                    <div id="searchResults" class="search-results"></div>
                </div>
            </div>

            <!-- Building Name - Centered -->
            <div class="building-title-main">
                <h1 id="buildingName">Loading...</h1>
            </div>

            <!-- Floor Selector - Centered Under Title -->
            <div class="floor-selector-wrapper">
                <select id="floorSelector" class="floor-selector">
                    <!-- Options populated dynamically -->
                </select>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="viewer-canvas-container">
            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="loading-overlay">
                <div class="spinner"></div>
                <h2>Loading floor plan...</h2>
                <p style="color: #666; margin-top: 10px; font-size: 14px;">Preparing interactive map...</p>
            </div>
            
            <!-- Welcome Instructions (shown on first visit) -->
            <div id="welcomeOverlay" class="welcome-overlay" style="display: none;">
                <div class="welcome-content">
                    <h2>
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        Welcome to IntraMap!
                    </h2>
                    <div class="welcome-instructions">
                        <div class="instruction-item">
                            <div class="instruction-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3B82F6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="m21 21-4.35-4.35"/>
                                </svg>
                            </div>
                            <p><strong>Search:</strong> Use the search bar to find any location</p>
                        </div>
                        <div class="instruction-item">
                            <div class="instruction-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3B82F6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 11l3 3L22 4"/>
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                                </svg>
                            </div>
                            <p><strong>Details:</strong> Tap any location to see more information</p>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="dismissWelcome()" style="margin-top: 20px; width: 100%;">
                        Got it, let's explore!
                    </button>
                </div>
            </div>

            <!-- Keyboard Help Overlay -->
            <div id="keyboardHelpOverlay" class="help-overlay" style="display: none;">
                <div class="help-popup">
                    <button class="help-close-btn" onclick="dismissKeyboardHelp()">‚úï</button>
                    <h3>Navigation Guide</h3>
                    <div class="help-shortcuts">
                        <div class="help-item">
                            <span class="help-key">üñ±Ô∏è</span>
                            <span class="help-desc">Scroll (Shift=horizontal, Ctrl=zoom)</span>
                        </div>
                        <div class="help-item">
                            <span class="help-key">‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÖÔ∏è‚û°Ô∏è</span>
                            <span class="help-desc">Pan map</span>
                        </div>
                        <div class="help-item">
                            <span class="help-key">+ / -</span>
                            <span class="help-desc">Zoom in/out</span>
                        </div>
                        <div class="help-item">
                            <span class="help-key">0</span>
                            <span class="help-desc">Reset view</span>
                        </div>
                        <div class="help-item">
                            <span class="help-key">Esc</span>
                            <span class="help-desc">Close popups</span>
                        </div>
                        <div class="help-item">
                            <span class="help-key">Space</span>
                            <span class="help-desc">Toggle welcome</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Canvas Wrapper -->
            <div class="viewer-canvas-wrapper">
                <canvas id="viewerCanvas"></canvas>
            </div>

            <!-- Controls -->
            <div class="viewer-controls">
                <div class="control-group">
                    <button class="btn btn-secondary btn-icon" onclick="zoomIn()" title="Zoom In (or press +)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                            <line x1="11" y1="8" x2="11" y2="14"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <button class="btn btn-secondary btn-icon" onclick="zoomOut()" title="Zoom Out (or press -)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <button class="btn btn-secondary btn-icon" onclick="resetView()" title="Reset View (or press 0)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 2v6h-6"/>
                            <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
                            <path d="M3 22v-6h6"/>
                            <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
                        </svg>
                    </button>
                    <button class="btn btn-secondary btn-icon" onclick="showKeyboardHelp()" title="Navigation Help (Keyboard & Mouse)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Object Info Popup -->
            <div id="objectPopup" class="object-popup">
                <div class="popup-header">
                    <div class="popup-title">
                        <h3 id="popupName">Place Name</h3>
                        <span id="popupFloor" class="badge badge-primary">Ground Floor</span>
                    </div>
                    <button class="popup-close" onclick="closePopup()">√ó</button>
                </div>
                <div id="popupTags" class="popup-tags"></div>
            </div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="lib/fabric.min.js"></script>
    <script src="js/icons.js"></script>
    <script src="js/api.js"></script>
    <script src="js/viewer.js"></script>
</body>

</html>